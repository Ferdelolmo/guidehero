{"version":3,"file":"faroXhrInstrumentation.js","sourceRoot":"","sources":["../../src/faroXhrInstrumentation.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,6BAA6B,EAAE,MAAM,iDAAiD,CAAC;AAIhG,OAAO,EAAE,IAAI,EAAE,kBAAkB,EAAoC,eAAe,EAAE,MAAM,uBAAuB,CAAC;AAMpH,MAAM,OAAO,sBAAuB,SAAQ,6BAA6B;IAGvE,YAAY,SAA8C,EAAE;QAC1D,KAAK,CAAC,MAAM,CAAC,CAAC;QAEd,MAAM,IAAI,GAAG,IAAqB,CAAC;QACnC,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IACtD,CAAC;IAED,wEAAwE;IACrD,UAAU;QAC3B,OAAO,CAAC,QAAsB,EAAgB,EAAE;YAC9C,MAAM,MAAM,GAAG,IAAI,CAAC;YACpB,OAAO,SAAS,SAAS,CAAuB,GAAG,IAAI;gBACrD,IAAI,IAAsB,CAAC;gBAC3B,IAAI,CAAC;oBACH,MAAM,MAAM,GAAW,IAAI,CAAC,CAAC,CAAC,CAAC;oBAC/B,IAAI,GAAG,GAAiB,kBAAkB,CAAC,IAAI,CAAC,CAAC,CAAC,CAAE,CAAC;oBAErD,IAAI,GAAG,MAAM,CAAC,gBAAgB,CAAC,IAAI,EAAE,GAAG,EAAE,MAAM,CAAC,CAAC;gBACpD,CAAC;gBAAC,OAAO,KAAK,EAAE,CAAC;oBACf,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;gBACnC,CAAC;gBAED,MAAM,aAAa,GAAG,IAAI,CAAC,GAAG,CAAC,mBAAmB,EAAE,CAAC;gBACrD,IACE,IAAI;oBACJ,aAAa;oBACb,CAAC,aAAwD,aAAxD,aAAa,uBAAb,aAAa,CAA6C,QAAQ,EAAE,MAAK,eAAe,CAAC,OAAO,EACjG,CAAC;oBACD,IAAI,CAAC,YAAY,CAAC,uBAAuB,EAAE,aAAa,CAAC,IAAI,CAAC,CAAC;oBAC/D,IAAI,CAAC,YAAY,CAAC,2BAA2B,EAAE,aAAa,CAAC,QAAQ,CAAC,CAAC;gBACzE,CAAC;gBAED,OAAO,QAAQ,CAAC,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;YACpC,CAAC,CAAC;QACJ,CAAC,CAAC;IACJ,CAAC;CACF","sourcesContent":["import type { Span } from '@opentelemetry/api';\nimport { XMLHttpRequestInstrumentation } from '@opentelemetry/instrumentation-xml-http-request';\nimport type { XMLHttpRequestInstrumentationConfig } from '@opentelemetry/instrumentation-xml-http-request';\nimport type { OpenFunction } from '@opentelemetry/instrumentation-xml-http-request/build/src/types';\n\nimport { faro, getUrlFromResource, type UserActionInternalInterface, UserActionState } from '@grafana/faro-web-sdk';\n\ntype Parent = {\n  _createSpan: (xhr: XMLHttpRequest, url: string, method: string) => Span | undefined;\n};\n\nexport class FaroXhrInstrumentation extends XMLHttpRequestInstrumentation {\n  private parentCreateSpan: Parent['_createSpan'];\n\n  constructor(config: XMLHttpRequestInstrumentationConfig = {}) {\n    super(config);\n\n    const self = this as any as Parent;\n    this.parentCreateSpan = self._createSpan.bind(this);\n  }\n\n  // Patching the parent's private method to handle url type string or URL\n  protected override _patchOpen() {\n    return (original: OpenFunction): OpenFunction => {\n      const plugin = this;\n      return function patchOpen(this: XMLHttpRequest, ...args): void {\n        let span: Span | undefined;\n        try {\n          const method: string = args[0];\n          let url: string | URL = getUrlFromResource(args[1])!;\n\n          span = plugin.parentCreateSpan(this, url, method);\n        } catch (error) {\n          faro.internalLogger.error(error);\n        }\n\n        const currentAction = faro.api.getActiveUserAction();\n        if (\n          span &&\n          currentAction &&\n          (currentAction as unknown as UserActionInternalInterface)?.getState() === UserActionState.Started\n        ) {\n          span.setAttribute('faro.action.user.name', currentAction.name);\n          span.setAttribute('faro.action.user.parentId', currentAction.parentId);\n        }\n\n        return original.apply(this, args);\n      };\n    };\n  }\n}\n"]}