{"version":3,"file":"userAction.js","sourceRoot":"","sources":["../../../../src/api/userActions/userAction.ts"],"names":[],"mappings":"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","sourcesContent":["import { faro } from '../../sdk/registerFaro';\nimport { type TransportItem, TransportItemType, type Transports } from '../../transports';\nimport { dateNow, genShortID, Observable, stringifyObjectValues } from '../../utils';\nimport { ItemBuffer } from '../ItemBuffer';\nimport { type MeasurementEvent } from '../measurements';\nimport { type APIEvent } from '../types';\n\nimport { userActionEventName, UserActionImportance, type UserActionImportanceType } from './const';\nimport { type UserActionInternalInterface, UserActionState, type UserActionTransportItemBuffer } from './types';\n\nexport default class UserAction\n  extends Observable\n  implements UserActionInternalInterface, UserActionTransportItemBuffer\n{\n  name: string;\n  id: string;\n  attributes?: Record<string, string>;\n  parentId: string;\n  trigger: string;\n  importance: UserActionImportanceType;\n  startTime?: number;\n  trackUserActionsExcludeItem?: (item: TransportItem<APIEvent>) => boolean;\n\n  private _state: UserActionState;\n  private _itemBuffer: ItemBuffer<TransportItem>;\n  private _transports: Transports;\n\n  constructor({\n    name,\n    parentId,\n    trigger,\n    transports,\n    attributes,\n    trackUserActionsExcludeItem,\n    importance = UserActionImportance.Normal,\n  }: {\n    name: string;\n    transports: Transports;\n    parentId?: string;\n    trigger: string;\n    attributes?: Record<string, string>;\n    trackUserActionsExcludeItem?: (item: TransportItem<APIEvent>) => boolean;\n    importance?: UserActionImportanceType;\n  }) {\n    super();\n    this.name = name;\n    this.attributes = attributes;\n    this.id = genShortID();\n    this.trigger = trigger;\n    this.parentId = parentId ?? this.id;\n    this.trackUserActionsExcludeItem = trackUserActionsExcludeItem;\n    this.importance = importance;\n\n    this._itemBuffer = new ItemBuffer<TransportItem>();\n    this._transports = transports;\n    this._state = UserActionState.Started;\n    this._start();\n  }\n\n  addItem(item: TransportItem): boolean {\n    if (this._state === UserActionState.Started) {\n      this._itemBuffer.addItem(item);\n      return true;\n    }\n    return false;\n  }\n\n  private _start(): void {\n    this._state = UserActionState.Started;\n    if (this._state === UserActionState.Started) {\n      this.startTime = dateNow();\n    }\n  }\n\n  halt() {\n    if (this._state !== UserActionState.Started) {\n      return;\n    }\n    this._state = UserActionState.Halted;\n    this.notify(this._state);\n  }\n\n  cancel() {\n    if (this._state === UserActionState.Started) {\n      // Empty the buffer\n      this._itemBuffer.flushBuffer();\n    }\n\n    this._state = UserActionState.Cancelled;\n    this.notify(this._state);\n  }\n\n  end() {\n    if (this._state === UserActionState.Cancelled) {\n      return;\n    }\n\n    const endTime = dateNow();\n    const duration = endTime - this.startTime!;\n    this._state = UserActionState.Ended;\n    this._itemBuffer.flushBuffer((item) => {\n      if (isExcludeFromUserAction(item, this.trackUserActionsExcludeItem)) {\n        this._transports.execute(item);\n        return;\n      }\n\n      const userActionItem = {\n        ...item,\n        payload: {\n          ...item.payload,\n          action: {\n            parentId: this.id,\n            name: this.name,\n          },\n        },\n      } as TransportItem;\n\n      this._transports.execute(userActionItem);\n    });\n\n    this._state = UserActionState.Ended;\n    this.notify(this._state);\n\n    faro.api.pushEvent(\n      userActionEventName,\n      {\n        userActionName: this.name,\n        userActionStartTime: this.startTime!.toString(),\n        userActionEndTime: endTime.toString(),\n        userActionDuration: duration.toString(),\n        userActionTrigger: this.trigger!,\n        userActionImportance: this.importance,\n        ...stringifyObjectValues(this.attributes),\n      },\n      undefined,\n      {\n        timestampOverwriteMs: this.startTime,\n        customPayloadTransformer: (payload) => {\n          payload.action = {\n            id: this.id,\n            name: this.name,\n          };\n\n          return payload;\n        },\n      }\n    );\n  }\n\n  getState(): UserActionState {\n    return this._state;\n  }\n}\n\nfunction isExcludeFromUserAction(\n  item: TransportItem<APIEvent>,\n  trackUserActionsExcludeItem: ((item: TransportItem<APIEvent>) => boolean) | undefined\n) {\n  return (\n    trackUserActionsExcludeItem?.(item) ||\n    (item.type === TransportItemType.MEASUREMENT && (item.payload as MeasurementEvent).type === 'web-vitals')\n  );\n}\n"]}