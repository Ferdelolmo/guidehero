{"version":3,"file":"initialize.test.js","sourceRoot":"","sources":["../../../../../../src/api/userActions/initialize.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { faro, UserActionImportance } from '../..';\nimport { mockConfig, mockInternalLogger } from '../../testUtils';\nimport { mockTransports } from '../apiTestHelpers';\n\nimport { userActionEventName } from './const';\nimport { initializeUserActionsAPI } from './initialize';\nimport { UserActionInternalInterface, UserActionsAPI } from './types';\nimport UserAction from './userAction';\n\njest.mock('../../sdk/registerFaro', () => ({\n  faro: {\n    api: {\n      pushEvent: jest.fn(),\n    },\n  },\n}));\n\ndescribe('initializeUserActionsAPI', () => {\n  let transports;\n  let config;\n  let internalLogger;\n  let api: UserActionsAPI;\n\n  beforeEach(() => {\n    transports = mockTransports;\n    // eslint-disable-next-line @typescript-eslint/no-unused-expressions\n    config = mockConfig({\n      userActionsInstrumentation: {\n        excludeItem: jest.fn(),\n      },\n    });\n    internalLogger = mockInternalLogger;\n    api = initializeUserActionsAPI({ transports, config, internalLogger });\n    jest.resetAllMocks();\n  });\n\n  afterEach(() => {\n    jest.resetAllMocks();\n  });\n\n  it('getActiveUserAction returns undefined before any action is created', () => {\n    expect(api.getActiveUserAction()).toBeUndefined();\n  });\n\n  it('startUserAction returns a new UserAction when none exists', () => {\n    const action = api.startUserAction('first');\n    expect(action).toBeInstanceOf(UserAction);\n    expect(api.getActiveUserAction()).toBe(action);\n  });\n\n  it('startUserAction has custom importance and trigger set', () => {\n    const action = api.startUserAction('first', undefined, {\n      importance: UserActionImportance.Critical,\n      triggerName: 'foo',\n    });\n    expect(action).toBeInstanceOf(UserAction);\n\n    const activeAction = api.getActiveUserAction();\n    expect(activeAction).toBe(action);\n\n    (activeAction as unknown as UserActionInternalInterface)?.end();\n\n    expect(faro.api.pushEvent).toHaveBeenCalledTimes(1);\n    expect(faro.api.pushEvent).toHaveBeenCalledWith(\n      expect.any(String),\n      expect.objectContaining({ userActionImportance: 'critical', userActionTrigger: 'foo' }),\n      undefined,\n      expect.any(Object)\n    );\n  });\n\n  it('subsequent startUserAction calls will return undefined as long as there is an action running', () => {\n    api.startUserAction('A');\n    const a2 = api.startUserAction('B');\n    expect(a2).not.toBeDefined();\n  });\n\n  it('getActiveUserAction returns undefined if the action is ended', () => {\n    const action = api.startUserAction('first');\n    (action as unknown as UserActionInternalInterface)?.end();\n    expect(api.getActiveUserAction()).toBeUndefined();\n  });\n\n  it('getActiveUserAction returns undefined if the action is cancelled', () => {\n    const action = api.startUserAction('first');\n    (action as unknown as UserActionInternalInterface)?.cancel();\n    expect(api.getActiveUserAction()).toBeUndefined();\n  });\n\n  it('user action has proper event name and contains all necessary attributes', () => {\n    const action = api.startUserAction(\n      'test-action',\n      { foo: 'bar' },\n      { importance: UserActionImportance.Critical, triggerName: 'foo' }\n    );\n    (action as unknown as UserActionInternalInterface)?.end();\n\n    expect(faro.api.pushEvent).toHaveBeenCalledWith(\n      userActionEventName,\n      expect.objectContaining({\n        userActionName: 'test-action',\n        userActionDuration: expect.any(String),\n        userActionImportance: 'critical',\n        userActionStartTime: expect.any(String),\n        userActionEndTime: expect.any(String),\n        userActionTrigger: 'foo',\n        foo: 'bar',\n      }),\n      undefined,\n      expect.any(Object)\n    );\n  });\n});\n"]}