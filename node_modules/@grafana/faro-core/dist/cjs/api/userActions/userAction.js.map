{"version":3,"file":"userAction.js","sourceRoot":"","sources":["../../../../src/api/userActions/userAction.ts"],"names":[],"mappings":"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","sourcesContent":["import { faro } from '../../sdk/registerFaro';\nimport { type TransportItem, TransportItemType, type Transports } from '../../transports';\nimport { dateNow, genShortID, Observable, stringifyObjectValues } from '../../utils';\nimport { ItemBuffer } from '../ItemBuffer';\nimport { type MeasurementEvent } from '../measurements';\nimport { type APIEvent } from '../types';\n\nimport { userActionEventName, UserActionImportance, type UserActionImportanceType } from './const';\nimport { type UserActionInternalInterface, UserActionState, type UserActionTransportItemBuffer } from './types';\n\nexport default class UserAction\n  extends Observable\n  implements UserActionInternalInterface, UserActionTransportItemBuffer\n{\n  name: string;\n  id: string;\n  attributes?: Record<string, string>;\n  parentId: string;\n  trigger: string;\n  importance: UserActionImportanceType;\n  startTime?: number;\n  trackUserActionsExcludeItem?: (item: TransportItem<APIEvent>) => boolean;\n\n  private _state: UserActionState;\n  private _itemBuffer: ItemBuffer<TransportItem>;\n  private _transports: Transports;\n\n  constructor({\n    name,\n    parentId,\n    trigger,\n    transports,\n    attributes,\n    trackUserActionsExcludeItem,\n    importance = UserActionImportance.Normal,\n  }: {\n    name: string;\n    transports: Transports;\n    parentId?: string;\n    trigger: string;\n    attributes?: Record<string, string>;\n    trackUserActionsExcludeItem?: (item: TransportItem<APIEvent>) => boolean;\n    importance?: UserActionImportanceType;\n  }) {\n    super();\n    this.name = name;\n    this.attributes = attributes;\n    this.id = genShortID();\n    this.trigger = trigger;\n    this.parentId = parentId ?? this.id;\n    this.trackUserActionsExcludeItem = trackUserActionsExcludeItem;\n    this.importance = importance;\n\n    this._itemBuffer = new ItemBuffer<TransportItem>();\n    this._transports = transports;\n    this._state = UserActionState.Started;\n    this._start();\n  }\n\n  addItem(item: TransportItem): boolean {\n    if (this._state === UserActionState.Started) {\n      this._itemBuffer.addItem(item);\n      return true;\n    }\n    return false;\n  }\n\n  private _start(): void {\n    this._state = UserActionState.Started;\n    if (this._state === UserActionState.Started) {\n      this.startTime = dateNow();\n    }\n  }\n\n  halt() {\n    if (this._state !== UserActionState.Started) {\n      return;\n    }\n    this._state = UserActionState.Halted;\n    this.notify(this._state);\n  }\n\n  cancel() {\n    if (this._state === UserActionState.Started) {\n      // Empty the buffer\n      this._itemBuffer.flushBuffer();\n    }\n\n    this._state = UserActionState.Cancelled;\n    this.notify(this._state);\n  }\n\n  end() {\n    if (this._state === UserActionState.Cancelled) {\n      return;\n    }\n\n    const endTime = dateNow();\n    const duration = endTime - this.startTime!;\n    this._state = UserActionState.Ended;\n    this._itemBuffer.flushBuffer((item) => {\n      if (isExcludeFromUserAction(item, this.trackUserActionsExcludeItem)) {\n        this._transports.execute(item);\n        return;\n      }\n\n      const userActionItem = {\n        ...item,\n        payload: {\n          ...item.payload,\n          action: {\n            parentId: this.id,\n            name: this.name,\n          },\n        },\n      } as TransportItem;\n\n      this._transports.execute(userActionItem);\n    });\n\n    this._state = UserActionState.Ended;\n    this.notify(this._state);\n\n    faro.api.pushEvent(\n      userActionEventName,\n      {\n        userActionName: this.name,\n        userActionStartTime: this.startTime!.toString(),\n        userActionEndTime: endTime.toString(),\n        userActionDuration: duration.toString(),\n        userActionTrigger: this.trigger!,\n        userActionImportance: this.importance,\n        ...stringifyObjectValues(this.attributes),\n      },\n      undefined,\n      {\n        timestampOverwriteMs: this.startTime,\n        customPayloadTransformer: (payload) => {\n          payload.action = {\n            id: this.id,\n            name: this.name,\n          };\n\n          return payload;\n        },\n      }\n    );\n  }\n\n  getState(): UserActionState {\n    return this._state;\n  }\n}\n\nfunction isExcludeFromUserAction(\n  item: TransportItem<APIEvent>,\n  trackUserActionsExcludeItem: ((item: TransportItem<APIEvent>) => boolean) | undefined\n) {\n  return (\n    trackUserActionsExcludeItem?.(item) ||\n    (item.type === TransportItemType.MEASUREMENT && (item.payload as MeasurementEvent).type === 'web-vitals')\n  );\n}\n"]}