{"version":3,"file":"userActionController.js","sourceRoot":"","sources":["../../../../src/instrumentations/userActions/userActionController.ts"],"names":[],"mappings":"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","sourcesContent":["// packages/web-sdk/src/instrumentations/userActions/userActionController.ts\nimport { Observable, UserActionState } from '@grafana/faro-core';\nimport type { Subscription, UserActionInternalInterface } from '@grafana/faro-core';\n\nimport { monitorDomMutations } from '../_internal/monitors/domMutationMonitor';\nimport { monitorHttpRequests } from '../_internal/monitors/httpRequestMonitor';\nimport { monitorPerformanceEntries } from '../_internal/monitors/performanceEntriesMonitor';\nimport type { HttpRequestMessagePayload } from '../_internal/monitors/types';\n\nimport { isRequestEndMessage, isRequestStartMessage, startTimeout } from './util';\n\nconst defaultFollowUpActionTimeRange = 100;\nconst defaultHaltTimeout = 10 * 1000;\n\nexport class UserActionController {\n  private readonly http = monitorHttpRequests();\n  private readonly dom = monitorDomMutations();\n  private readonly perf = monitorPerformanceEntries();\n\n  private allMonitorsSub?: Subscription;\n  private stateSub?: Subscription;\n  private followUpTid?: number;\n  private haltTid?: number;\n\n  private isValid = false;\n  private runningRequests = new Map<string, HttpRequestMessagePayload>();\n\n  constructor(private userAction: UserActionInternalInterface) {}\n\n  attach(): void {\n    // Subscribe to monitors while action is active/halting\n    this.allMonitorsSub = new Observable()\n      .merge(this.http, this.dom, this.perf)\n      .takeWhile(() => [UserActionState.Started, UserActionState.Halted].includes(this.userAction.getState()))\n      .filter((msg) => {\n        // If the user action is in halt state, we only keep listening to ended http requests\n        if (\n          this.userAction.getState() === UserActionState.Halted &&\n          !(isRequestEndMessage(msg) && this.runningRequests.has(msg.request.requestId))\n        ) {\n          return false;\n        }\n\n        return true;\n      })\n      .subscribe((msg) => {\n        if (isRequestStartMessage(msg)) {\n          // An action is on halt if it has pending items, like pending HTTP requests.\n          // In this case we start a separate timeout to wait for the requests to finish\n          // If in the halt state, we stop adding Faro signals to the action's buffer (see userActionLifecycleHandler.ts)\n          // But we are still subscribed to\n          this.runningRequests.set(msg.request.requestId, msg.request);\n        }\n\n        if (isRequestEndMessage(msg)) {\n          this.runningRequests.delete(msg.request.requestId);\n        }\n\n        if (!isRequestEndMessage(msg)) {\n          if (!this.isValid) {\n            this.isValid = true;\n          }\n          this.scheduleFollowUp();\n        } else if (this.userAction.getState() === UserActionState.Halted && this.runningRequests.size === 0) {\n          this.endAction();\n        }\n      });\n\n    // When UA ends or cancels, cleanup timers/subscriptions\n    this.stateSub = (this.userAction as unknown as Observable)\n      .filter((s: UserActionState) => [UserActionState.Ended, UserActionState.Cancelled].includes(s))\n      .first()\n      .subscribe(() => this.cleanup());\n\n    // initial follow-up window in case nothing else happens\n    this.scheduleFollowUp();\n  }\n\n  private scheduleFollowUp() {\n    this.clearTimer(this.followUpTid);\n    this.followUpTid = setTimeout(() => {\n      // If action just started and there's pending work, go to halted\n      if (this.userAction.getState() === UserActionState.Started && this.runningRequests.size > 0) {\n        this.haltAction();\n        return;\n      }\n\n      // If we saw any relevant activity in the window, finish as ended\n      if (this.isValid) {\n        this.endAction();\n        return;\n      }\n\n      // Otherwise, no signals => cancel\n      this.cancelAction();\n    }, defaultFollowUpActionTimeRange) as any;\n  }\n\n  private haltAction() {\n    if (this.userAction.getState() !== UserActionState.Started) {\n      return;\n    }\n    this.userAction.halt();\n    this.startHaltTimeout();\n  }\n\n  private startHaltTimeout() {\n    this.clearTimer(this.haltTid);\n    this.haltTid = startTimeout(\n      this.haltTid,\n      () => {\n        // If still halted after timeout, end\n        if (this.userAction.getState() === UserActionState.Halted) {\n          this.endAction();\n        }\n      },\n      defaultHaltTimeout\n    ) as any;\n  }\n\n  private endAction() {\n    this.userAction.end();\n    this.cleanup();\n  }\n\n  private cancelAction() {\n    this.userAction.cancel();\n    this.cleanup();\n  }\n\n  private cleanup() {\n    this.clearTimer(this.followUpTid);\n    this.clearTimer(this.haltTid);\n    this.allMonitorsSub?.unsubscribe();\n    this.stateSub?.unsubscribe();\n    this.allMonitorsSub = undefined;\n    this.stateSub = undefined;\n    this.runningRequests.clear();\n  }\n\n  private clearTimer(id?: number) {\n    if (id) {\n      clearTimeout(id);\n    }\n  }\n}\n"]}