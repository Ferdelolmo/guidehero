{"version":3,"file":"httpRequestMonitor.js","sourceRoot":"","sources":["../../../../../src/instrumentations/_internal/monitors/httpRequestMonitor.ts"],"names":[],"mappings":"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","sourcesContent":["import { genShortID, Observable } from '@grafana/faro-core';\n\nimport { getUrlFromResource, isUrlIgnored } from '../../../utils/url';\n\nimport { MESSAGE_TYPE_HTTP_REQUEST_END, MESSAGE_TYPE_HTTP_REQUEST_START } from './const';\nimport type { HttpRequestEndMessage, HttpRequestMessagePayload, HttpRequestStartMessage } from './types';\n\ntype RequestProps = HttpRequestMessagePayload;\n\nconst apiTypeFetch = 'fetch';\nconst apiTypeXhr = 'xhr';\n\n/**\n * Monitors if any http requests are in progress.\n */\nlet httpRequestObservable: Observable<HttpRequestStartMessage | HttpRequestEndMessage> | undefined;\nlet isInstrumented = false;\nlet originalXhrOpen: typeof XMLHttpRequest.prototype.open | undefined;\nlet originalFetchFn: typeof window.fetch | undefined;\n\nexport function monitorHttpRequests(): Observable<HttpRequestStartMessage | HttpRequestEndMessage> {\n  if (httpRequestObservable) {\n    return httpRequestObservable;\n  }\n\n  httpRequestObservable = new Observable<HttpRequestStartMessage | HttpRequestEndMessage>();\n\n  function emitStartMessage(requestProps: RequestProps) {\n    httpRequestObservable!.notify({\n      type: MESSAGE_TYPE_HTTP_REQUEST_START,\n      request: requestProps,\n    });\n  }\n\n  function emitEndMessage(requestProps: RequestProps) {\n    httpRequestObservable!.notify({\n      type: MESSAGE_TYPE_HTTP_REQUEST_END,\n      request: requestProps,\n    });\n  }\n\n  if (!isInstrumented) {\n    monitorFetch({\n      onRequestStart: emitStartMessage,\n      onRequestEnd: emitEndMessage,\n    });\n\n    monitorXhr({\n      onRequestStart: emitStartMessage,\n      onRequestEnd: emitEndMessage,\n    });\n\n    isInstrumented = true;\n  }\n\n  return httpRequestObservable;\n}\n\nfunction monitorXhr({\n  onRequestStart,\n  onRequestEnd,\n}: {\n  onRequestStart: (props: RequestProps) => void;\n  onRequestEnd: (props: RequestProps) => void;\n}) {\n  if (!originalXhrOpen) {\n    originalXhrOpen = XMLHttpRequest.prototype.open;\n  }\n\n  XMLHttpRequest.prototype.open = function () {\n    const url = arguments[1];\n    const isIgnoredUrl = isUrlIgnored(url);\n    const method = arguments[0];\n\n    const requestId = genShortID();\n\n    // request has started to load data.\n    this.addEventListener('loadstart', function () {\n      if (!isIgnoredUrl) {\n        onRequestStart({ url, method, requestId, apiType: apiTypeXhr });\n      }\n    });\n\n    // transaction completes successfully.\n    this.addEventListener('load', function () {\n      if (!isIgnoredUrl) {\n        onRequestEnd({ url, method, requestId, apiType: apiTypeXhr });\n      }\n    });\n\n    this.addEventListener('error', function () {\n      if (!isIgnoredUrl) {\n        onRequestEnd({ url, method, requestId, apiType: apiTypeXhr });\n      }\n    });\n\n    this.addEventListener('abort', function () {\n      if (!isIgnoredUrl) {\n        onRequestEnd({ url, method, requestId, apiType: apiTypeXhr });\n      }\n    });\n    originalXhrOpen!.apply(this, arguments as any);\n  };\n}\n\nfunction monitorFetch({\n  onRequestEnd,\n  onRequestStart,\n}: {\n  onRequestStart: (props: RequestProps) => void;\n  onRequestEnd: (props: RequestProps) => void;\n}) {\n  if (!originalFetchFn) {\n    originalFetchFn = window.fetch;\n  }\n\n  window.fetch = function () {\n    const url = getUrlFromResource(arguments[0]) ?? '';\n    const isIgnoredUrl = isUrlIgnored(url);\n    const method = (arguments[1] ?? {}).method;\n\n    const requestId = genShortID();\n\n    if (!isIgnoredUrl) {\n      onRequestStart({ url, method, requestId, apiType: apiTypeFetch });\n    }\n\n    return originalFetchFn!\n      .apply(this, arguments as any)\n      .then((response) => {\n        if (!isIgnoredUrl) {\n          onRequestEnd({ url, method, requestId, apiType: apiTypeFetch });\n        }\n        return response;\n      })\n      .catch((error) => {\n        if (!isIgnoredUrl) {\n          onRequestEnd({ url, method, requestId, apiType: apiTypeFetch });\n        }\n        throw error;\n      });\n  };\n}\n\n// Test-only utility to reset instrumentation and singleton between tests\nexport function __resetHttpRequestMonitorForTests() {\n  if (originalXhrOpen) {\n    XMLHttpRequest.prototype.open = originalXhrOpen;\n  }\n  if (originalFetchFn) {\n    (window as any).fetch = originalFetchFn;\n  }\n  httpRequestObservable = undefined;\n  isInstrumented = false;\n  originalXhrOpen = undefined;\n  originalFetchFn = undefined;\n}\n"]}