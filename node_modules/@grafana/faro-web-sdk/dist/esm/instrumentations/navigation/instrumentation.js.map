{"version":3,"file":"instrumentation.js","sourceRoot":"","sources":["../../../../src/instrumentations/navigation/instrumentation.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,mBAAmB,EAAE,IAAI,EAAE,UAAU,EAAE,OAAO,EAAE,MAAM,oBAAoB,CAAC;AAEpF,OAAO,EAAE,qBAAqB,EAAE,mBAAmB,EAAE,qBAAqB,EAAE,MAAM,oCAAoC,CAAC;AACvH,OAAO,EAAE,mBAAmB,EAAE,MAAM,0CAA0C,CAAC;AAC/E,OAAO,EAAE,mBAAmB,EAAE,MAAM,0CAA0C,CAAC;AAC/E,OAAO,EAAE,mBAAmB,EAAE,MAAM,0CAA0C,CAAC;AAC/E,OAAO,EAAE,iBAAiB,EAAE,MAAM,wCAAwC,CAAC;AAE3E,MAAM,OAAO,yBAA0B,SAAQ,mBAAmB;IAAlE;;QACW,SAAI,GAAG,kDAAkD,CAAC;QAC1D,YAAO,GAAG,OAAO,CAAC;IAyC7B,CAAC;IAvCU,UAAU;QACjB,MAAM,WAAW,GAAG,mBAAmB,EAAE,CAAC;QAC1C,MAAM,mBAAmB,GAAG,mBAAmB,EAAE,CAAC;QAClD,MAAM,UAAU,GAAG,iBAAiB,EAAE,CAAC;QACvC,MAAM,kBAAkB,GAAG,mBAAmB,CAAC,CAAC,aAAa,EAAE,SAAS,CAAC,CAAC,CAAC;QAE3E,MAAM,qBAAqB,GAAG,IAAI,qBAAqB,CACrD,IAAI,UAAU,EAAE,CAAC,KAAK,CAAC,WAAW,EAAE,mBAAmB,EAAE,UAAU,CAAC,EACpE;YACE,YAAY,EAAE,GAAG;YACjB,cAAc,EAAE,EAAE,GAAG,IAAI;YACzB,gBAAgB,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC,qBAAqB,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC;YAC3F,cAAc,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC,mBAAmB,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC;SACxF,CACF,CAAC;QAEF,qBAAqB;aAClB,MAAM,CAAC,CAAC,GAAG,EAAE,EAAE;YACd,OAAO,GAAG,CAAC,OAAO,KAAK,gBAAgB,CAAC;QAC1C,CAAC,CAAC;aACD,SAAS,CAAC,CAAC,GAAG,EAAE,EAAE;;YACjB,IACE,CAAA,MAAA,GAAG,CAAC,MAAM,0CAAE,IAAI,CAAC,CAAC,CAAM,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,YAAY,CAAC;iBACrD,MAAA,GAAG,CAAC,MAAM,0CAAE,IAAI,CAAC,CAAC,CAAM,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,cAAc,CAAC,CAAA,EACvD,CAAC;gBACD,MAAM,SAAS,GAAG,MAAA,GAAG,CAAC,MAAM,0CAAE,IAAI,CAAC,CAAC,CAAM,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,YAAY,CAAC,CAAC;gBACxE,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,iBAAiB,EAAE;oBACpC,OAAO,EAAE,SAAS,aAAT,SAAS,uBAAT,SAAS,CAAE,IAAI;oBACxB,KAAK,EAAE,SAAS,aAAT,SAAS,uBAAT,SAAS,CAAE,EAAE;oBACpB,YAAY,EAAE,MAAM,CAAC,IAAI,CAAC;oBAC1B,QAAQ,EAAE,GAAG,CAAC,QAAQ;iBACvB,CAAC,CAAC;YACL,CAAC;QACH,CAAC,CAAC,CAAC;QAEL,kBAAkB,CAAC,SAAS,CAAC,GAAG,EAAE;YAChC,qBAAqB,CAAC,aAAa,EAAE,CAAC;QACxC,CAAC,CAAC,CAAC;IACL,CAAC;CACF","sourcesContent":["import { BaseInstrumentation, faro, Observable, VERSION } from '@grafana/faro-core';\n\nimport { ActivityWindowTracker, isRequestEndMessage, isRequestStartMessage } from '../_internal/activityWindowTracker';\nimport { monitorDomMutations } from '../_internal/monitors/domMutationMonitor';\nimport { monitorHttpRequests } from '../_internal/monitors/httpRequestMonitor';\nimport { monitorInteractions } from '../_internal/monitors/interactionMonitor';\nimport { monitorUrlChanges } from '../_internal/monitors/urlChangeMonitor';\n\nexport class NavigationInstrumentation extends BaseInstrumentation {\n  readonly name = '@grafana/faro-web-sdk:instrumentation-navigation';\n  readonly version = VERSION;\n\n  override initialize(): void {\n    const httpMonitor = monitorHttpRequests();\n    const domMutationsMonitor = monitorDomMutations();\n    const urlMonitor = monitorUrlChanges();\n    const interactionMonitor = monitorInteractions(['pointerdown', 'keydown']);\n\n    const activityWindowTracker = new ActivityWindowTracker(\n      new Observable().merge(httpMonitor, domMutationsMonitor, urlMonitor),\n      {\n        inactivityMs: 100,\n        drainTimeoutMs: 10 * 1000,\n        isOperationStart: (msg) => (isRequestStartMessage(msg) ? msg.request.requestId : undefined),\n        isOperationEnd: (msg) => (isRequestEndMessage(msg) ? msg.request.requestId : undefined),\n      }\n    );\n\n    activityWindowTracker\n      .filter((msg) => {\n        return msg.message === 'tracking-ended';\n      })\n      .subscribe((msg) => {\n        if (\n          msg.events?.some((e: any) => e.type === 'url-change') &&\n          msg.events?.some((e: any) => e.type === 'dom-mutation')\n        ) {\n          const urlChange = msg.events?.find((e: any) => e.type === 'url-change');\n          faro.api.pushEvent('faro.navigation', {\n            fromUrl: urlChange?.from,\n            toUrl: urlChange?.to,\n            sameDocument: String(true),\n            duration: msg.duration,\n          });\n        }\n      });\n\n    interactionMonitor.subscribe(() => {\n      activityWindowTracker.startTracking();\n    });\n  }\n}\n"]}