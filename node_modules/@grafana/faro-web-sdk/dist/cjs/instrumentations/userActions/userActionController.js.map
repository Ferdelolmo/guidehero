{"version":3,"file":"userActionController.js","sourceRoot":"","sources":["../../../../src/instrumentations/userActions/userActionController.ts"],"names":[],"mappings":";;;AAAA,4EAA4E;AAC5E,gDAAiE;AAGjE,+EAA+E;AAC/E,+EAA+E;AAC/E,6FAA4F;AAG5F,+BAAkF;AAElF,IAAM,8BAA8B,GAAG,GAAG,CAAC;AAC3C,IAAM,kBAAkB,GAAG,EAAE,GAAG,IAAI,CAAC;AAErC;IAaE,8BAAoB,UAAuC;QAAvC,eAAU,GAAV,UAAU,CAA6B;QAZ1C,SAAI,GAAG,IAAA,wCAAmB,GAAE,CAAC;QAC7B,QAAG,GAAG,IAAA,wCAAmB,GAAE,CAAC;QAC5B,SAAI,GAAG,IAAA,qDAAyB,GAAE,CAAC;QAO5C,YAAO,GAAG,KAAK,CAAC;QAChB,oBAAe,GAAG,IAAI,GAAG,EAAqC,CAAC;IAET,CAAC;IAE/D,qCAAM,GAAN;QAAA,iBA+CC;QA9CC,uDAAuD;QACvD,IAAI,CAAC,cAAc,GAAG,IAAI,sBAAU,EAAE;aACnC,KAAK,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,GAAG,EAAE,IAAI,CAAC,IAAI,CAAC;aACrC,SAAS,CAAC,cAAM,OAAA,CAAC,2BAAe,CAAC,OAAO,EAAE,2BAAe,CAAC,MAAM,CAAC,CAAC,QAAQ,CAAC,KAAI,CAAC,UAAU,CAAC,QAAQ,EAAE,CAAC,EAAtF,CAAsF,CAAC;aACvG,MAAM,CAAC,UAAC,GAAG;YACV,qFAAqF;YACrF,IACE,KAAI,CAAC,UAAU,CAAC,QAAQ,EAAE,KAAK,2BAAe,CAAC,MAAM;gBACrD,CAAC,CAAC,IAAA,0BAAmB,EAAC,GAAG,CAAC,IAAI,KAAI,CAAC,eAAe,CAAC,GAAG,CAAC,GAAG,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,EAC9E,CAAC;gBACD,OAAO,KAAK,CAAC;YACf,CAAC;YAED,OAAO,IAAI,CAAC;QACd,CAAC,CAAC;aACD,SAAS,CAAC,UAAC,GAAG;YACb,IAAI,IAAA,4BAAqB,EAAC,GAAG,CAAC,EAAE,CAAC;gBAC/B,4EAA4E;gBAC5E,8EAA8E;gBAC9E,+GAA+G;gBAC/G,iCAAiC;gBACjC,KAAI,CAAC,eAAe,CAAC,GAAG,CAAC,GAAG,CAAC,OAAO,CAAC,SAAS,EAAE,GAAG,CAAC,OAAO,CAAC,CAAC;YAC/D,CAAC;YAED,IAAI,IAAA,0BAAmB,EAAC,GAAG,CAAC,EAAE,CAAC;gBAC7B,KAAI,CAAC,eAAe,CAAC,MAAM,CAAC,GAAG,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;YACrD,CAAC;YAED,IAAI,CAAC,IAAA,0BAAmB,EAAC,GAAG,CAAC,EAAE,CAAC;gBAC9B,IAAI,CAAC,KAAI,CAAC,OAAO,EAAE,CAAC;oBAClB,KAAI,CAAC,OAAO,GAAG,IAAI,CAAC;gBACtB,CAAC;gBACD,KAAI,CAAC,gBAAgB,EAAE,CAAC;YAC1B,CAAC;iBAAM,IAAI,KAAI,CAAC,UAAU,CAAC,QAAQ,EAAE,KAAK,2BAAe,CAAC,MAAM,IAAI,KAAI,CAAC,eAAe,CAAC,IAAI,KAAK,CAAC,EAAE,CAAC;gBACpG,KAAI,CAAC,SAAS,EAAE,CAAC;YACnB,CAAC;QACH,CAAC,CAAC,CAAC;QAEL,wDAAwD;QACxD,IAAI,CAAC,QAAQ,GAAI,IAAI,CAAC,UAAoC;aACvD,MAAM,CAAC,UAAC,CAAkB,IAAK,OAAA,CAAC,2BAAe,CAAC,KAAK,EAAE,2BAAe,CAAC,SAAS,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC,EAA9D,CAA8D,CAAC;aAC9F,KAAK,EAAE;aACP,SAAS,CAAC,cAAM,OAAA,KAAI,CAAC,OAAO,EAAE,EAAd,CAAc,CAAC,CAAC;QAEnC,wDAAwD;QACxD,IAAI,CAAC,gBAAgB,EAAE,CAAC;IAC1B,CAAC;IAEO,+CAAgB,GAAxB;QAAA,iBAkBC;QAjBC,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAClC,IAAI,CAAC,WAAW,GAAG,UAAU,CAAC;YAC5B,gEAAgE;YAChE,IAAI,KAAI,CAAC,UAAU,CAAC,QAAQ,EAAE,KAAK,2BAAe,CAAC,OAAO,IAAI,KAAI,CAAC,eAAe,CAAC,IAAI,GAAG,CAAC,EAAE,CAAC;gBAC5F,KAAI,CAAC,UAAU,EAAE,CAAC;gBAClB,OAAO;YACT,CAAC;YAED,iEAAiE;YACjE,IAAI,KAAI,CAAC,OAAO,EAAE,CAAC;gBACjB,KAAI,CAAC,SAAS,EAAE,CAAC;gBACjB,OAAO;YACT,CAAC;YAED,kCAAkC;YAClC,KAAI,CAAC,YAAY,EAAE,CAAC;QACtB,CAAC,EAAE,8BAA8B,CAAQ,CAAC;IAC5C,CAAC;IAEO,yCAAU,GAAlB;QACE,IAAI,IAAI,CAAC,UAAU,CAAC,QAAQ,EAAE,KAAK,2BAAe,CAAC,OAAO,EAAE,CAAC;YAC3D,OAAO;QACT,CAAC;QACD,IAAI,CAAC,UAAU,CAAC,IAAI,EAAE,CAAC;QACvB,IAAI,CAAC,gBAAgB,EAAE,CAAC;IAC1B,CAAC;IAEO,+CAAgB,GAAxB;QAAA,iBAYC;QAXC,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAC9B,IAAI,CAAC,OAAO,GAAG,IAAA,mBAAY,EACzB,IAAI,CAAC,OAAO,EACZ;YACE,qCAAqC;YACrC,IAAI,KAAI,CAAC,UAAU,CAAC,QAAQ,EAAE,KAAK,2BAAe,CAAC,MAAM,EAAE,CAAC;gBAC1D,KAAI,CAAC,SAAS,EAAE,CAAC;YACnB,CAAC;QACH,CAAC,EACD,kBAAkB,CACZ,CAAC;IACX,CAAC;IAEO,wCAAS,GAAjB;QACE,IAAI,CAAC,UAAU,CAAC,GAAG,EAAE,CAAC;QACtB,IAAI,CAAC,OAAO,EAAE,CAAC;IACjB,CAAC;IAEO,2CAAY,GAApB;QACE,IAAI,CAAC,UAAU,CAAC,MAAM,EAAE,CAAC;QACzB,IAAI,CAAC,OAAO,EAAE,CAAC;IACjB,CAAC;IAEO,sCAAO,GAAf;;QACE,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAClC,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAC9B,MAAA,IAAI,CAAC,cAAc,0CAAE,WAAW,EAAE,CAAC;QACnC,MAAA,IAAI,CAAC,QAAQ,0CAAE,WAAW,EAAE,CAAC;QAC7B,IAAI,CAAC,cAAc,GAAG,SAAS,CAAC;QAChC,IAAI,CAAC,QAAQ,GAAG,SAAS,CAAC;QAC1B,IAAI,CAAC,eAAe,CAAC,KAAK,EAAE,CAAC;IAC/B,CAAC;IAEO,yCAAU,GAAlB,UAAmB,EAAW;QAC5B,IAAI,EAAE,EAAE,CAAC;YACP,YAAY,CAAC,EAAE,CAAC,CAAC;QACnB,CAAC;IACH,CAAC;IACH,2BAAC;AAAD,CAAC,AAnID,IAmIC;AAnIY,oDAAoB","sourcesContent":["// packages/web-sdk/src/instrumentations/userActions/userActionController.ts\nimport { Observable, UserActionState } from '@grafana/faro-core';\nimport type { Subscription, UserActionInternalInterface } from '@grafana/faro-core';\n\nimport { monitorDomMutations } from '../_internal/monitors/domMutationMonitor';\nimport { monitorHttpRequests } from '../_internal/monitors/httpRequestMonitor';\nimport { monitorPerformanceEntries } from '../_internal/monitors/performanceEntriesMonitor';\nimport type { HttpRequestMessagePayload } from '../_internal/monitors/types';\n\nimport { isRequestEndMessage, isRequestStartMessage, startTimeout } from './util';\n\nconst defaultFollowUpActionTimeRange = 100;\nconst defaultHaltTimeout = 10 * 1000;\n\nexport class UserActionController {\n  private readonly http = monitorHttpRequests();\n  private readonly dom = monitorDomMutations();\n  private readonly perf = monitorPerformanceEntries();\n\n  private allMonitorsSub?: Subscription;\n  private stateSub?: Subscription;\n  private followUpTid?: number;\n  private haltTid?: number;\n\n  private isValid = false;\n  private runningRequests = new Map<string, HttpRequestMessagePayload>();\n\n  constructor(private userAction: UserActionInternalInterface) {}\n\n  attach(): void {\n    // Subscribe to monitors while action is active/halting\n    this.allMonitorsSub = new Observable()\n      .merge(this.http, this.dom, this.perf)\n      .takeWhile(() => [UserActionState.Started, UserActionState.Halted].includes(this.userAction.getState()))\n      .filter((msg) => {\n        // If the user action is in halt state, we only keep listening to ended http requests\n        if (\n          this.userAction.getState() === UserActionState.Halted &&\n          !(isRequestEndMessage(msg) && this.runningRequests.has(msg.request.requestId))\n        ) {\n          return false;\n        }\n\n        return true;\n      })\n      .subscribe((msg) => {\n        if (isRequestStartMessage(msg)) {\n          // An action is on halt if it has pending items, like pending HTTP requests.\n          // In this case we start a separate timeout to wait for the requests to finish\n          // If in the halt state, we stop adding Faro signals to the action's buffer (see userActionLifecycleHandler.ts)\n          // But we are still subscribed to\n          this.runningRequests.set(msg.request.requestId, msg.request);\n        }\n\n        if (isRequestEndMessage(msg)) {\n          this.runningRequests.delete(msg.request.requestId);\n        }\n\n        if (!isRequestEndMessage(msg)) {\n          if (!this.isValid) {\n            this.isValid = true;\n          }\n          this.scheduleFollowUp();\n        } else if (this.userAction.getState() === UserActionState.Halted && this.runningRequests.size === 0) {\n          this.endAction();\n        }\n      });\n\n    // When UA ends or cancels, cleanup timers/subscriptions\n    this.stateSub = (this.userAction as unknown as Observable)\n      .filter((s: UserActionState) => [UserActionState.Ended, UserActionState.Cancelled].includes(s))\n      .first()\n      .subscribe(() => this.cleanup());\n\n    // initial follow-up window in case nothing else happens\n    this.scheduleFollowUp();\n  }\n\n  private scheduleFollowUp() {\n    this.clearTimer(this.followUpTid);\n    this.followUpTid = setTimeout(() => {\n      // If action just started and there's pending work, go to halted\n      if (this.userAction.getState() === UserActionState.Started && this.runningRequests.size > 0) {\n        this.haltAction();\n        return;\n      }\n\n      // If we saw any relevant activity in the window, finish as ended\n      if (this.isValid) {\n        this.endAction();\n        return;\n      }\n\n      // Otherwise, no signals => cancel\n      this.cancelAction();\n    }, defaultFollowUpActionTimeRange) as any;\n  }\n\n  private haltAction() {\n    if (this.userAction.getState() !== UserActionState.Started) {\n      return;\n    }\n    this.userAction.halt();\n    this.startHaltTimeout();\n  }\n\n  private startHaltTimeout() {\n    this.clearTimer(this.haltTid);\n    this.haltTid = startTimeout(\n      this.haltTid,\n      () => {\n        // If still halted after timeout, end\n        if (this.userAction.getState() === UserActionState.Halted) {\n          this.endAction();\n        }\n      },\n      defaultHaltTimeout\n    ) as any;\n  }\n\n  private endAction() {\n    this.userAction.end();\n    this.cleanup();\n  }\n\n  private cancelAction() {\n    this.userAction.cancel();\n    this.cleanup();\n  }\n\n  private cleanup() {\n    this.clearTimer(this.followUpTid);\n    this.clearTimer(this.haltTid);\n    this.allMonitorsSub?.unsubscribe();\n    this.stateSub?.unsubscribe();\n    this.allMonitorsSub = undefined;\n    this.stateSub = undefined;\n    this.runningRequests.clear();\n  }\n\n  private clearTimer(id?: number) {\n    if (id) {\n      clearTimeout(id);\n    }\n  }\n}\n"]}