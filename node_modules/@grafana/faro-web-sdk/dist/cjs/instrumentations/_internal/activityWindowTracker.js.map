{"version":3,"file":"activityWindowTracker.js","sourceRoot":"","sources":["../../../../src/instrumentations/_internal/activityWindowTracker.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAOA,sDAEC;AAED,kDAEC;AAbD,gDAAgD;AAEhD,0CAAkG;AAKlG,SAAgB,qBAAqB,CAAC,GAAQ;IAC5C,OAAO,GAAG,CAAC,IAAI,KAAK,uCAA+B,CAAC;AACtD,CAAC;AAED,SAAgB,mBAAmB,CAAC,GAAQ;IAC1C,OAAO,GAAG,CAAC,IAAI,KAAK,qCAA6B,CAAC;AACpD,CAAC;AASD;;;;GAIG;AACH;IAA2C,yCAAU;IAYnD,+BAAY,gBAA4B,EAAE,OAAsC;;QAC9E,YAAA,MAAK,WAAE,SAAC;QAVF,eAAS,GAAG,KAAK,CAAC;QAWxB,KAAI,CAAC,gBAAgB,GAAG,gBAAgB,CAAC;QACzC,KAAI,CAAC,QAAQ,GAAG;YACd,YAAY,EAAE,MAAA,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,YAAY,mCAAI,GAAG;YAC1C,cAAc,EAAE,MAAA,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,cAAc,mCAAI,EAAE,GAAG,IAAI;YACpD,gBAAgB,EAAE,MAAA,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,gBAAgB,mCAAI,CAAC,cAAM,OAAA,SAAS,EAAT,CAAS,CAAC;YAChE,cAAc,EAAE,MAAA,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,cAAc,mCAAI,CAAC,cAAM,OAAA,SAAS,EAAT,CAAS,CAAC;SACnB,CAAC;QAC5C,KAAI,CAAC,WAAW,EAAE,CAAC;;IACrB,CAAC;IAEO,2CAAW,GAAnB;QAAA,iBAqBC;QApBC,IAAI,CAAC,gBAAgB;aAClB,MAAM,CAAC;YACN,OAAO,KAAI,CAAC,SAAS,CAAC;QACxB,CAAC,CAAC;aACD,SAAS,CAAC,UAAC,KAAK;;YACf,KAAI,CAAC,cAAc,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;YACjC,MAAA,KAAI,CAAC,cAAc,0CAAE,IAAI,CAAC,KAAK,CAAC,CAAC;YAEjC,IAAM,QAAQ,GAAG,KAAI,CAAC,QAAQ,CAAC,gBAAgB,CAAC,KAAY,CAAC,CAAC;YAC9D,IAAI,QAAQ,EAAE,CAAC;gBACb,MAAA,KAAI,CAAC,iBAAiB,0CAAE,GAAG,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;YAC9C,CAAC;YAED,IAAM,MAAM,GAAG,KAAI,CAAC,QAAQ,CAAC,cAAc,CAAC,KAAY,CAAC,CAAC;YAC1D,IAAI,MAAM,EAAE,CAAC;gBACX,MAAA,KAAI,CAAC,iBAAiB,0CAAE,MAAM,CAAC,MAAM,CAAC,CAAC;YACzC,CAAC;YAED,KAAI,CAAC,wBAAwB,EAAE,CAAC;QAClC,CAAC,CAAC,CAAC;IACP,CAAC;IAED,6CAAa,GAAb;QACE,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACnB,OAAO;QACT,CAAC;QAED,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACtB,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAC7B,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAEjC,IAAI,CAAC,MAAM,CAAC;YACV,OAAO,EAAE,kBAAkB;SAC5B,CAAC,CAAC;QAEH,IAAI,CAAC,cAAc,GAAG,EAAE,CAAC;QACzB,IAAI,CAAC,iBAAiB,GAAG,IAAI,GAAG,EAAsB,CAAC;QACvD,IAAI,CAAC,wBAAwB,EAAE,CAAC;IAClC,CAAC;IAED,4CAAY,GAAZ;QACE,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACvB,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;QACtC,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QAEjC,IAAI,QAAQ,GAAG,CAAC,CAAC;QACjB,IAAI,IAAI,CAAC,mBAAmB,EAAE,EAAE,CAAC;YAC/B,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,UAAW,CAAC;QAC3C,CAAC;aAAM,CAAC;YACN,QAAQ,GAAG,IAAI,CAAC,cAAc,CAAC,CAAC,CAAC,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC,UAAW,CAAC,CAAC,CAAC,CAAC,CAAC;QAC9E,CAAC;QAED,IAAI,CAAC,MAAM,CAAC;YACV,OAAO,EAAE,gBAAgB;YACzB,MAAM,EAAE,IAAI,CAAC,cAAc;YAC3B,QAAQ,EAAE,QAAQ;SACnB,CAAC,CAAC;IACL,CAAC;IAEO,wDAAwB,GAAhC;QAAA,iBAYC;QAXC,IAAI,CAAC,cAAc,GAAG,YAAY,CAChC,IAAI,CAAC,cAAc,EACnB;YACE,IAAI,KAAI,CAAC,mBAAmB,EAAE,EAAE,CAAC;gBAC/B,KAAI,CAAC,kBAAkB,EAAE,CAAC;YAC5B,CAAC;iBAAM,CAAC;gBACN,KAAI,CAAC,YAAY,EAAE,CAAC;YACtB,CAAC;QACH,CAAC,EACD,IAAI,CAAC,QAAQ,CAAC,YAAY,CAC3B,CAAC;IACJ,CAAC;IAEO,kDAAkB,GAA1B;QAAA,iBAQC;QAPC,IAAI,CAAC,SAAS,GAAG,YAAY,CAC3B,IAAI,CAAC,SAAS,EACd;YACE,KAAI,CAAC,YAAY,EAAE,CAAC;QACtB,CAAC,EACD,IAAI,CAAC,QAAQ,CAAC,cAAc,CAC7B,CAAC;IACJ,CAAC;IAEO,mDAAmB,GAA3B;QACE,OAAO,CAAC,CAAC,IAAI,CAAC,iBAAiB,IAAI,IAAI,CAAC,iBAAiB,CAAC,IAAI,GAAG,CAAC,CAAC;IACrE,CAAC;IAEO,2CAAW,GAAnB,UAAoB,EAAW;QAC7B,IAAI,EAAE,EAAE,CAAC;YACP,YAAY,CAAC,EAAE,CAAC,CAAC;QACnB,CAAC;IACH,CAAC;IACH,4BAAC;AAAD,CAAC,AArHD,CAA2C,sBAAU,GAqHpD;AArHY,sDAAqB;AAuHlC,SAAS,YAAY,CAAC,SAA6B,EAAE,EAAc,EAAE,KAAa;IAChF,IAAI,SAAS,EAAE,CAAC;QACd,YAAY,CAAC,SAAS,CAAC,CAAC;IAC1B,CAAC;IAED,iEAAiE;IACjE,SAAS,GAAG,UAAU,CAAC;QACrB,EAAE,EAAE,CAAC;IACP,CAAC,EAAE,KAAK,CAAC,CAAC;IAEV,OAAO,SAAS,CAAC;AACnB,CAAC","sourcesContent":["import { Observable } from '@grafana/faro-core';\n\nimport { MESSAGE_TYPE_HTTP_REQUEST_END, MESSAGE_TYPE_HTTP_REQUEST_START } from './monitors/const';\nimport type { HttpRequestEndMessage, HttpRequestStartMessage } from './monitors/types';\n\ntype OperationKey = string;\n\nexport function isRequestStartMessage(msg: any): msg is HttpRequestStartMessage {\n  return msg.type === MESSAGE_TYPE_HTTP_REQUEST_START;\n}\n\nexport function isRequestEndMessage(msg: any): msg is HttpRequestEndMessage {\n  return msg.type === MESSAGE_TYPE_HTTP_REQUEST_END;\n}\n\nexport interface ActivityWindowTrackerOptions<TMsg = any> {\n  inactivityMs?: number;\n  drainTimeoutMs?: number;\n  isOperationStart?: (msg: TMsg) => OperationKey | undefined;\n  isOperationEnd?: (msg: TMsg) => OperationKey | undefined;\n}\n\n/**\n * Tracks events in a timeâ€‘boxed activity window. When the window goes quiet for `inactivityMs`,\n * it enters a draining phase: new short events are ignored; only active operations are awaited\n * until they end or `drainTimeoutMs` elapses.\n */\nexport class ActivityWindowTracker extends Observable {\n  eventsObservable: Observable;\n\n  private _tracking = false;\n  private _inactivityTid?: number;\n  private _drainTid?: number;\n  private _currentEvents?: any[];\n  private _activeOperations?: Map<OperationKey, true>;\n  private _startTime?: number;\n  private _lastEventTime?: number;\n  private _options: Required<ActivityWindowTrackerOptions>;\n\n  constructor(eventsObservable: Observable, options?: ActivityWindowTrackerOptions) {\n    super();\n    this.eventsObservable = eventsObservable;\n    this._options = {\n      inactivityMs: options?.inactivityMs ?? 100,\n      drainTimeoutMs: options?.drainTimeoutMs ?? 10 * 1000,\n      isOperationStart: options?.isOperationStart ?? (() => undefined),\n      isOperationEnd: options?.isOperationEnd ?? (() => undefined),\n    } as Required<ActivityWindowTrackerOptions>;\n    this._initialize();\n  }\n\n  private _initialize() {\n    this.eventsObservable\n      .filter(() => {\n        return this._tracking;\n      })\n      .subscribe((event) => {\n        this._lastEventTime = Date.now();\n        this._currentEvents?.push(event);\n\n        const startKey = this._options.isOperationStart(event as any);\n        if (startKey) {\n          this._activeOperations?.set(startKey, true);\n        }\n\n        const endKey = this._options.isOperationEnd(event as any);\n        if (endKey) {\n          this._activeOperations?.delete(endKey);\n        }\n\n        this._scheduleInactivityCheck();\n      });\n  }\n\n  startTracking() {\n    if (this._tracking) {\n      return;\n    }\n\n    this._tracking = true;\n    this._startTime = Date.now();\n    this._lastEventTime = Date.now();\n\n    this.notify({\n      message: 'tracking-started',\n    });\n\n    this._currentEvents = [];\n    this._activeOperations = new Map<OperationKey, true>();\n    this._scheduleInactivityCheck();\n  }\n\n  stopTracking() {\n    this._tracking = false;\n    this._clearTimer(this._inactivityTid);\n    this._clearTimer(this._drainTid);\n\n    let duration = 0;\n    if (this.hasActiveOperations()) {\n      duration = Date.now() - this._startTime!;\n    } else {\n      duration = this._lastEventTime ? this._lastEventTime - this._startTime! : 0;\n    }\n\n    this.notify({\n      message: 'tracking-ended',\n      events: this._currentEvents,\n      duration: duration,\n    });\n  }\n\n  private _scheduleInactivityCheck() {\n    this._inactivityTid = startTimeout(\n      this._inactivityTid,\n      () => {\n        if (this.hasActiveOperations()) {\n          this._startDrainTimeout();\n        } else {\n          this.stopTracking();\n        }\n      },\n      this._options.inactivityMs\n    );\n  }\n\n  private _startDrainTimeout() {\n    this._drainTid = startTimeout(\n      this._drainTid,\n      () => {\n        this.stopTracking();\n      },\n      this._options.drainTimeoutMs\n    );\n  }\n\n  private hasActiveOperations(): boolean {\n    return !!this._activeOperations && this._activeOperations.size > 0;\n  }\n\n  private _clearTimer(id?: number) {\n    if (id) {\n      clearTimeout(id);\n    }\n  }\n}\n\nfunction startTimeout(timeoutId: number | undefined, cb: () => void, delay: number) {\n  if (timeoutId) {\n    clearTimeout(timeoutId);\n  }\n\n  //@ts-expect-error for some reason vscode is using the node types\n  timeoutId = setTimeout(() => {\n    cb();\n  }, delay);\n\n  return timeoutId;\n}\n"]}