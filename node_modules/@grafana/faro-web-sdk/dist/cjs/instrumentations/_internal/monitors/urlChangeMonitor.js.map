{"version":3,"file":"urlChangeMonitor.js","sourceRoot":"","sources":["../../../../../src/instrumentations/_internal/monitors/urlChangeMonitor.ts"],"names":[],"mappings":"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","sourcesContent":["import { Observable } from '@grafana/faro-core';\n\nexport const MESSAGE_TYPE_URL_CHANGE = 'url-change';\n\nexport type UrlChangeMessage = {\n  type: typeof MESSAGE_TYPE_URL_CHANGE;\n  from: string;\n  to: string;\n  trigger: 'pushState' | 'replaceState' | 'popstate' | 'hashchange' | 'navigate' | 'navigate-intercept';\n};\n\nlet urlChangeObservable: Observable<UrlChangeMessage> | undefined;\nlet isInstrumented = false;\nlet lastHref: string | undefined;\nlet originalPushState: typeof window.history.pushState | undefined;\nlet originalReplaceState: typeof window.history.replaceState | undefined;\nlet onPopStateHandler: ((this: Window, ev: PopStateEvent) => any) | undefined;\nlet onHashChangeHandler: ((this: Window, ev: HashChangeEvent) => any) | undefined;\nlet onNavigateHandler: ((this: any, ev: any) => any) | undefined;\nlet originalNavigateEventIntercept: (((this: any, options?: any) => any) & { _faroWrapped?: boolean }) | undefined;\n\nexport function monitorUrlChanges(): Observable<UrlChangeMessage> {\n  if (!urlChangeObservable) {\n    urlChangeObservable = new Observable<UrlChangeMessage>();\n    lastHref = location.href;\n  }\n\n  function emit(trigger: UrlChangeMessage['trigger'], toOverride?: string) {\n    const next = toOverride ?? location.href;\n    if (next !== lastHref) {\n      urlChangeObservable!.notify({ type: MESSAGE_TYPE_URL_CHANGE, from: lastHref!, to: next, trigger });\n      lastHref = next;\n    }\n  }\n\n  if (!isInstrumented) {\n    const hasNavigation = 'navigation' in window && 'NavigateEvent' in (window as any);\n\n    if (hasNavigation) {\n      // Prefer Navigation API when supported: do not patch history or add popstate/hashchange listeners\n      onNavigateHandler = (e: any) => {\n        try {\n          const destination = e?.destination as { url?: string; sameDocument?: boolean } | undefined;\n          if (destination?.sameDocument && typeof destination.url === 'string') {\n            emit('navigate', destination.url);\n          }\n        } catch (_err) {\n          // Swallow to avoid impacting host app\n        }\n      };\n      (window as any).navigation.addEventListener('navigate', onNavigateHandler as any);\n\n      const NavigateEventConstructor = (window as any).NavigateEvent;\n      if (\n        NavigateEventConstructor &&\n        NavigateEventConstructor.prototype &&\n        typeof NavigateEventConstructor.prototype.intercept === 'function'\n      ) {\n        if (!originalNavigateEventIntercept) {\n          originalNavigateEventIntercept = NavigateEventConstructor.prototype.intercept;\n        }\n\n        // Wrap intercept to detect soft navigations (cross-document turned same-document)\n        NavigateEventConstructor.prototype.intercept = function (this: any, options?: any) {\n          try {\n            const canIntercept = !!this?.canIntercept;\n            const destination = this?.destination as { url?: string; sameDocument?: boolean } | undefined;\n            if (\n              canIntercept &&\n              destination &&\n              destination.sameDocument === false &&\n              typeof destination.url === 'string'\n            ) {\n              emit('navigate-intercept', destination.url);\n            }\n          } catch (_err) {\n            // ignore\n          }\n          return originalNavigateEventIntercept!.call(this, options);\n        } as typeof originalNavigateEventIntercept;\n      }\n\n      isInstrumented = true;\n    } else {\n      // Fallback: history API patching + popstate/hashchange\n      if (!originalPushState) {\n        originalPushState = window.history.pushState;\n      }\n      window.history.pushState = function (...args: Parameters<typeof window.history.pushState>) {\n        const result = originalPushState!.apply(window.history, args as any);\n        emit('pushState');\n        return result;\n      } as typeof window.history.pushState;\n\n      if (!originalReplaceState) {\n        originalReplaceState = window.history.replaceState;\n      }\n      window.history.replaceState = function (...args: Parameters<typeof window.history.replaceState>) {\n        const result = originalReplaceState!.apply(window.history, args as any);\n        emit('replaceState');\n        return result;\n      } as typeof window.history.replaceState;\n\n      onPopStateHandler = () => emit('popstate');\n      onHashChangeHandler = () => emit('hashchange');\n      window.addEventListener('popstate', onPopStateHandler);\n      window.addEventListener('hashchange', onHashChangeHandler);\n\n      isInstrumented = true;\n    }\n  }\n\n  return urlChangeObservable;\n}\n\n// Test-only utility to reset state between tests\nexport function __resetUrlChangeMonitorForTests() {\n  if (onPopStateHandler) {\n    window.removeEventListener('popstate', onPopStateHandler);\n  }\n  if (onHashChangeHandler) {\n    window.removeEventListener('hashchange', onHashChangeHandler);\n  }\n  if (onNavigateHandler && (window as any).navigation?.removeEventListener) {\n    (window as any).navigation.removeEventListener('navigate', onNavigateHandler as any);\n  }\n  if (originalPushState) {\n    window.history.pushState = originalPushState;\n  }\n  if (originalReplaceState) {\n    window.history.replaceState = originalReplaceState;\n  }\n  if (originalNavigateEventIntercept && (window as any).NavigateEvent?.prototype) {\n    (window as any).NavigateEvent.prototype.intercept = originalNavigateEventIntercept;\n  }\n  urlChangeObservable = undefined;\n  isInstrumented = false;\n  lastHref = undefined;\n  onPopStateHandler = undefined;\n  onHashChangeHandler = undefined;\n  onNavigateHandler = undefined;\n  originalPushState = undefined;\n  originalReplaceState = undefined;\n  originalNavigateEventIntercept = undefined;\n}\n"]}