{"version":3,"file":"instrumentation.js","sourceRoot":"","sources":["../../../../src/instrumentations/navigation/instrumentation.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA,gDAAoF;AAEpF,4EAAuH;AACvH,+EAA+E;AAC/E,+EAA+E;AAC/E,+EAA+E;AAC/E,2EAA2E;AAE3E;IAA+C,6CAAmB;IAAlE;;QACW,UAAI,GAAG,kDAAkD,CAAC;QAC1D,aAAO,GAAG,mBAAO,CAAC;;IAyC7B,CAAC;IAvCU,8CAAU,GAAnB;QACE,IAAM,WAAW,GAAG,IAAA,wCAAmB,GAAE,CAAC;QAC1C,IAAM,mBAAmB,GAAG,IAAA,wCAAmB,GAAE,CAAC;QAClD,IAAM,UAAU,GAAG,IAAA,oCAAiB,GAAE,CAAC;QACvC,IAAM,kBAAkB,GAAG,IAAA,wCAAmB,EAAC,CAAC,aAAa,EAAE,SAAS,CAAC,CAAC,CAAC;QAE3E,IAAM,qBAAqB,GAAG,IAAI,6CAAqB,CACrD,IAAI,sBAAU,EAAE,CAAC,KAAK,CAAC,WAAW,EAAE,mBAAmB,EAAE,UAAU,CAAC,EACpE;YACE,YAAY,EAAE,GAAG;YACjB,cAAc,EAAE,EAAE,GAAG,IAAI;YACzB,gBAAgB,EAAE,UAAC,GAAG,IAAK,OAAA,CAAC,IAAA,6CAAqB,EAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC,EAAhE,CAAgE;YAC3F,cAAc,EAAE,UAAC,GAAG,IAAK,OAAA,CAAC,IAAA,2CAAmB,EAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC,EAA9D,CAA8D;SACxF,CACF,CAAC;QAEF,qBAAqB;aAClB,MAAM,CAAC,UAAC,GAAG;YACV,OAAO,GAAG,CAAC,OAAO,KAAK,gBAAgB,CAAC;QAC1C,CAAC,CAAC;aACD,SAAS,CAAC,UAAC,GAAG;;YACb,IACE,CAAA,MAAA,GAAG,CAAC,MAAM,0CAAE,IAAI,CAAC,UAAC,CAAM,IAAK,OAAA,CAAC,CAAC,IAAI,KAAK,YAAY,EAAvB,CAAuB,CAAC;iBACrD,MAAA,GAAG,CAAC,MAAM,0CAAE,IAAI,CAAC,UAAC,CAAM,IAAK,OAAA,CAAC,CAAC,IAAI,KAAK,cAAc,EAAzB,CAAyB,CAAC,CAAA,EACvD,CAAC;gBACD,IAAM,SAAS,GAAG,MAAA,GAAG,CAAC,MAAM,0CAAE,IAAI,CAAC,UAAC,CAAM,IAAK,OAAA,CAAC,CAAC,IAAI,KAAK,YAAY,EAAvB,CAAuB,CAAC,CAAC;gBACxE,gBAAI,CAAC,GAAG,CAAC,SAAS,CAAC,iBAAiB,EAAE;oBACpC,OAAO,EAAE,SAAS,aAAT,SAAS,uBAAT,SAAS,CAAE,IAAI;oBACxB,KAAK,EAAE,SAAS,aAAT,SAAS,uBAAT,SAAS,CAAE,EAAE;oBACpB,YAAY,EAAE,MAAM,CAAC,IAAI,CAAC;oBAC1B,QAAQ,EAAE,GAAG,CAAC,QAAQ;iBACvB,CAAC,CAAC;YACL,CAAC;QACH,CAAC,CAAC,CAAC;QAEL,kBAAkB,CAAC,SAAS,CAAC;YAC3B,qBAAqB,CAAC,aAAa,EAAE,CAAC;QACxC,CAAC,CAAC,CAAC;IACL,CAAC;IACH,gCAAC;AAAD,CAAC,AA3CD,CAA+C,+BAAmB,GA2CjE;AA3CY,8DAAyB","sourcesContent":["import { BaseInstrumentation, faro, Observable, VERSION } from '@grafana/faro-core';\n\nimport { ActivityWindowTracker, isRequestEndMessage, isRequestStartMessage } from '../_internal/activityWindowTracker';\nimport { monitorDomMutations } from '../_internal/monitors/domMutationMonitor';\nimport { monitorHttpRequests } from '../_internal/monitors/httpRequestMonitor';\nimport { monitorInteractions } from '../_internal/monitors/interactionMonitor';\nimport { monitorUrlChanges } from '../_internal/monitors/urlChangeMonitor';\n\nexport class NavigationInstrumentation extends BaseInstrumentation {\n  readonly name = '@grafana/faro-web-sdk:instrumentation-navigation';\n  readonly version = VERSION;\n\n  override initialize(): void {\n    const httpMonitor = monitorHttpRequests();\n    const domMutationsMonitor = monitorDomMutations();\n    const urlMonitor = monitorUrlChanges();\n    const interactionMonitor = monitorInteractions(['pointerdown', 'keydown']);\n\n    const activityWindowTracker = new ActivityWindowTracker(\n      new Observable().merge(httpMonitor, domMutationsMonitor, urlMonitor),\n      {\n        inactivityMs: 100,\n        drainTimeoutMs: 10 * 1000,\n        isOperationStart: (msg) => (isRequestStartMessage(msg) ? msg.request.requestId : undefined),\n        isOperationEnd: (msg) => (isRequestEndMessage(msg) ? msg.request.requestId : undefined),\n      }\n    );\n\n    activityWindowTracker\n      .filter((msg) => {\n        return msg.message === 'tracking-ended';\n      })\n      .subscribe((msg) => {\n        if (\n          msg.events?.some((e: any) => e.type === 'url-change') &&\n          msg.events?.some((e: any) => e.type === 'dom-mutation')\n        ) {\n          const urlChange = msg.events?.find((e: any) => e.type === 'url-change');\n          faro.api.pushEvent('faro.navigation', {\n            fromUrl: urlChange?.from,\n            toUrl: urlChange?.to,\n            sameDocument: String(true),\n            duration: msg.duration,\n          });\n        }\n      });\n\n    interactionMonitor.subscribe(() => {\n      activityWindowTracker.startTracking();\n    });\n  }\n}\n"]}